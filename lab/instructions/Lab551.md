# Exercise 1: Enabling Defender CSPM plan

To gain access to the capabilities provided by Defender CSPM, you'll need to enable the Defender Cloud Security Posture Management (CSPM) plan on your subscription

1. Open **Azure Portal** at https://portal.azure.com.

#### Task 1 - Enable Log Analytics Workspace

1. Using the **Search resources, service, and docs** bar, type in Log Analytics.

1. Select **Log Analytics workspaces** from the list.

1. Select the **+ Create** button near the bottom of the page.

1. Enter the following data to define your workspace:

| Field | Value |
| :--- | :--- |
| Subscritpion | Use the default - Ignote-lod... |
| Resource Group | Create new with an name of RG-Defender |
| Name | wrkspcIgnite |
| Region | Use the default |

1. Select **Review + Create** then select **Create** once the confirmation is complete.

1. Select **Go to resource** with the workspace setup is done.

#### Task 2 - Enable CSPM in Defender for Cloud

1. Return the **Home** screen of the **Azure Portal**.

1. Use **Search** at the top of the portal to navigate to Microsoft Defender for Cloud feature.

1. From the Defender for Cloud menu, open **Management** and then the **Environment Settings** page.

1. At the bottom of the page, fully expand the subscription tree. Select the relevant subscription. Should look like **Ignite-lod...**.

1. If prompted select **Maybe later** for the auto-provisioning.

1. In the **Defender plans** page, select **Defender CSPM** turn the status to **ON**.

1. Select **Settings** under **Monitoring Coverage**.

1. Select **Cancel** on the pop-up to disable Agentless scanning.

1. Turn ON the following settings under Monitoring Coverage:

- **Agentless scanning for machines** to enable vulnerability assessment and software inventory.
- **Kubernetes API access** to continuously detect and manage Kubernetes resources.
- **Registry access** to scan for vulnerabilities in registered Kubernetes images.
- **Sensitive data discovery** to identify and protect sensitive data across your cloud environments.
- **Permissions Management (CIEM)** to manage and audit permissions across your cloud resources.
- **API Security Posture Management** for vulnerability assessment to scan for API published in your API Management services.

1. Click **Continue** to proceed.

1. Click on **Save** to save the changes.

  >Note on Agentless Scanning - Due to the fact that this lab is only 1.5 hours long and scanning is designed to take 24 hour, you will not see results during this lab.  You can use the screenshots provided in the lab to see the potential results.

1. Select the **X** in the upper-right to close the **Settings | Defender plans** page.

1. Look at the bottom of the screen where you picked your **Subscription** a few steps earlier.

1. Find and Select the **wrkspcIgnite** Log Analytics workspace we created previously.

1. Set the **Foundational CSPM** to **On**.

1. Select the **Save** button to complete the action.

  >Note - Enable this feature may take up to 2 minutes to complete.

1. Select the **X** in the upper-right to close the **Settings | Defender plans** page.

===

# Use-case for the exercise

A hypothetical organization, "Adatum Corporation," had a robust cybersecurity infrastructure in place. However, one day, an attacker used a brute force or password spraying attack to gain access to an Internet-exposed server of the organization.

The attacker could quickly move laterally through the network, exploiting vulnerabilities on the Internet-exposed servers and gaining access to the organization's Storage Accounts, SQL servers, and Key Vaults. The SOC department was alerted by Defender for Cloud on the "Brute Force, Password Spray" IOC/IOA, and quickly realized something was wrong when they noticed unusual activity on the servers and Storage Accounts.

In response to the attack, the security engineers leveraged the attack path analysis to identify the entry point of the attack and the path the attackers used to move laterally through the network. Based on this analysis, they were able to close the entry point and cut off the attackers' access to the organization's data.

Additionally, they utilized Sensitive Data Discovery to identify and secure sensitive information that could be at risk of exposure. Permission Management tools were implemented to review and tighten access controls, ensuring that permissions were strictly granted based on the principle of least privilege. The discovery of plaintext secrets in the environment prompted the integration of Secret Discovery tools to encrypt sensitive data and manage secrets more securely.

The IT department didn't stop there. They also took a proactive approach by implementing security recommendations to fix the vulnerabilities on the Internet-exposed servers and prevent similar attacks in the future. Utilizing the Risk Prioritization feature of DCSPM, the security team gained full visibility into which recommendations should be prioritized, focusing their efforts on addressing the most critical vulnerabilities first. Additionally, they implemented a robust incident response plan and conducted regular security training for employees.

Thanks to the combination of both reactive and proactive measures, Adatum Corporation was able to prevent a major data breach and keep their sensitive information safe. This hypothetical use case demonstrates the importance of having both a reactive and proactive approach when it comes to cybersecurity, including performing attack path and security risk analysis, implementing security recommendations, assigning/managing change actions to the proper owners, and educating employees to prevent future attacks.

===

# Exercise 2: Analyzing and Mitigating Attack Paths

In this exercise, we will explore the Attack Path feature of Defender CSPM. Through a hands-on scenario, you will learn how to identify and mitigate potential security breaches that exploit critical vulnerabilities and inadequate permission settings in cloud environments.

#### Scenario Overview
An Internet-exposed VM has been identified with High severity vulnerabilities, which includes read permissions to a key vault. This setup poses a significant risk as it may allow attackers to exploit Remote Code Execution (RCE) vulnerabilities on the server. The lack of "least privileged" permission configurations could enable intruders to access sensitive secrets stored in the Key Vault once the server is breached.

#### Objective
Utilize the Attack Path feature to trace and understand how an attacker could navigate through your cloud environment and identify critical steps to mitigate this risk.

1. Open **Microsoft Defender for Cloud** if you are not already there.

1. From the **Defender for Cloud** menu, open the **Attack path analysis** page.

  >Note - If you Attack path analysis is blank, please use the screenshots to review

![image](https://github.com/Azure/Microsoft-Defender-for-Cloud/blob/main/Labs/Images/module17Img01.png?raw=true)

1. You will find Attack path view as below:

![image](https://github.com/Azure/Microsoft-Defender-for-Cloud/blob/main/Labs/Images/module17Img02.png?raw=true)

1. Find the Attack Path with the name "Internet exposed Azure VM with high severity vulnerabilities allows lateral movement to Azure Key Vault", and open it by clicking it:

![image](https://github.com/Azure/Microsoft-Defender-for-Cloud/blob/main/Labs/Images/module17Img03.png?raw=true)

![image](https://github.com/Azure/Microsoft-Defender-for-Cloud/blob/main/Labs/Images/module17Img04.png?raw=true)

5. Here, you can observe the attack path and the resources involved in the attack vector. By clicking on each node/element of the attack path, you can review detailed information from the right panel. This panel provides related insights and valuable information, helping you understand how the attack can occur and what factors contribute to the lateral movements through the resources involved.

![image](https://github.com/Azure/Microsoft-Defender-for-Cloud/blob/main/Labs/Images/module17Img05.png?raw=true)

1. Remediate the recommendations to resolve the attack path. In the main Attack Path view, locate and click on the Remediation tab. This action opens the remediation section, which displays the specific security recommendations needed to mitigate the attack vector.

![image](https://github.com/Azure/Microsoft-Defender-for-Cloud/blob/main/Labs/Images/module17Img06.png?raw=true)

1. Explore the rest of the Attack paths found in your Environment and remidiate

===

# Exercise 3: Build Query with Cloud Security Explorer

In this exercise, you will utilize the Cloud Security Explorer in Microsoft Defender for Cloud to perform a type of ad-hoc risk analysis by querying and identifying risky resources within your cloud environment. You will learn how to use predefined query templates and the query builder to explore, for example, vulnerabilities, identities, and sensitive data exposures in your virtual machines and storage accounts. This hands-on experience will enhance your understanding of how to effectively search for Virtual Machines (Servers) vulnerable to Remote Code Execution, pinpoint specific vulnerabilities, and identify storage accounts with sensitive data,, or you can also expand the query to add additional condition as you like, or build a total new one.

1. If not already open, go to the **Azure Portal** and navigate to the **Microsoft Defender for Cloud** page.

1. From the **Defender for Cloud** menu, open the **Cloud Security Explorer** page.

![image](https://user-images.githubusercontent.com/102209701/215828929-98a0e9fe-1f0e-4ac8-97f5-4bed96d0d174.png)

1. Select a predefined query Template **Internet exposed VMs with high severity vulnerabilities** and select Search.

1. You will find the list of VMs with high severity Vulnerabilities.

1. Select a predefined query Template **Internet exposed SQL servers with managed identity** and select Search.

1. You will find the list of SQL servers with managed identity.

1. You can also explore and build your own queries using query builder as shown below: In the dropdown select Compute -> Virtual Machines -> Azure Virtual Machines.

![image](https://user-images.githubusercontent.com/102209701/230957007-478bf8c3-eb3e-4c04-908b-514710d30967.png)

1. Click on + and under select condition, select Security -> vulnerable to remote code execution.

![image](https://user-images.githubusercontent.com/102209701/230956384-cee04cd8-8a49-4345-a9a4-4b0e8e619ca9.png)

1. Explore your Environment for Virtual Machines with a specific vulnerability.

![image](https://user-images.githubusercontent.com/102209701/230958117-60a425b1-ded4-443c-a11c-001fc3f51b17.png)

1. Search for Virtual Machines that have a specific Vulnerability.

![image](https://user-images.githubusercontent.com/102209701/230958614-cdc86d27-a4a9-4622-a137-f695af2cb37a.png)

Explore your Environment for Storage Accounts exposed to the Internet.

![image](https://user-images.githubusercontent.com/102209701/230959026-54412825-60ce-4b53-957f-21d5d17afd53.png)

![image](https://user-images.githubusercontent.com/102209701/230959308-d2256f43-1413-4c6d-8d4a-381f706f903d.png)

1. Explore your Environment for Storage Accounts with Sensitive Data (require that you have a Storagfe Account containing sensitive data such as, for example, a list of US Social Security Number - a make up fake list that you can create in a text file).

![image](https://user-images.githubusercontent.com/102209701/230960239-65feb795-4ab7-47e1-8f0e-fff3e8ef2085.png)

===

# Exercise 4: Assign Governance Rule

In this exercise, you will learn to establish and manage recommendation remediation auto assignement and configuration through MDC Governance rules within Microsoft Defender for Cloud.

Assume the role of a security administrator at a large organization managing multiple Azure subscriptions. Your challenge is to automate the remediation process for high-severity vulnerabilities, ensuring they are addressed promptly to maintain a robust security posture.

Through this exercise, you will configure a governance rule that ensures all high-severity vulnerabilities are remediated within 90 days, enhancing the security and compliance of your cloud environment. This process not only helps maintain your organization's security posture but also introduces a structured approach to managing cloud resources responsibly.

1. Open **Azure Portal** and navigate to the **Microsoft Defender for Cloud** page.

1. From the Defender for Cloud's menu, open the Environment Settings page and select the relevant subscription.

1. Under **Settings**, select **Governance rules**.

1. Click on **+ Create governance rule**.

1. Provide the following information:

- Rule name = Ignite Governance Rule
- Select scope at **subscription level**
- Set priority to **100**.

1. Under conditions:

- Set **By severity** to **High**.
- Set **Owner** to **By email address** and specify the email address your admin account in the **Resources** tab.
- Set **Remediation timeframe** to **90 days**.

1. Enable the option to **Notify Owners weekly** about open and overdue tasks and select **Create**.

  >NOTE - if the Create button is greyed-out, make sure you have successfully chosen and Email Address.  Don't just type the email address in the box.

![Governance Rule Creation](https://user-images.githubusercontent.com/102209701/215829686-cd5fc20c-32be-4822-be5f-04e5f85563c5.png)

1. After saving, click on Governance report to view the status of tasks, categorized as Complete, Overdue, On-time, Unassigned.

![Governance Report View](https://user-images.githubusercontent.com/102209701/215830577-947675fb-2f05-44a0-9482-fbd58a86d360.png)

===

# Exercise 5: Analyze Security Recommendations by Risk Level - Risk Prioritization

In this exercise, you will learn how to utilize the Risk Prioritization feature in Microsoft Defender for Cloud to analyze and prioritize security recommendations based on their risk levels. This capability allows security teams to focus on the most critical issues that could impact the security posture of their cloud environments.

You are part of a security team managing cloud assets for a multinational corporation. Due to the vast number of assets and continuous deployment cycles, it is crucial to prioritize security tasks effectively. By focusing on high-risk recommendations, you can optimize your remediation efforts and allocate resources more efficiently, enhancing overall security.

This exercise aims to enhance your ability to effectively prioritize and manage the remediation of security vulnerabilities within your cloud environment. By focusing on high-risk recommendations, you can ensure that critical vulnerabilities are addressed promptly, reducing the potential impact on your organization's operations and data security.

  >Lab Timing Note - The process to find potential risk and make recommendations based on real-world usage of your environment takes time. It is recommended to wait at least 24-hours before checking the recommendations.  For the purpose of this lab, we have been running for less than 1-hour, so your list may be blank. In that case, please use the provided screenshots to see the actual images.

1. Open **Azure Portal** and navigate to the **Microsoft Defender for Cloud** page.

1. Go to the **Recommendations** section.

![image](https://github.com/Azure/Microsoft-Defender-for-Cloud/blob/main/Labs/Images/module17Img07.png?raw=true)

1. Sort or filter the recommendations by risk level by clicking on the Risk level column to sort from Low to Critical, or vice versa. This will organize the recommendations starting from the highest to the lowest risk levels. Here, you can view multiple valuable insights as they are exposed through each column of the records. You can see the risk factors that have contributed to the risk level evaluation, the number of attack paths found for the resource, whether an owner has been assigned to its remediation, and the status of the change.

![image](https://github.com/Azure/Microsoft-Defender-for-Cloud/blob/main/Labs/Images/module17Img08.png?raw=true)

1. Select a high-risk recommendation to view detailed information about the risk factors, affected resources, and suggested remediation steps.

![image](https://github.com/Azure/Microsoft-Defender-for-Cloud/blob/main/Labs/Images/module17Img09.png?raw=true)

1. Analyze the recommendation details to understand the potential business impact and the exploitability of the vulnerability. Perhaps you can view the findings by clicking the Findings tab, or you can view all the Attack paths found associated to the resource in question.

1. Plan and assign remediation tasks based on the priority of the risks. Use the integrated task management tools within Defender for Cloud to assign tasks to appropriate team members by clicking Assign owner & set due date.

1. Monitor the progress of remediation efforts through the Governance and Compliance dashboard to ensure that high-risk vulnerabilities are addressed in a timely manner.

===

# Exercise 6: Leverage Cloud Identity Entitlement Management - Permissions Management

This exercise will guide you through the process of enabling and using Permissions Management in Microsoft Defender for Cloud. This feature helps manage and secure identity and access configurations across your cloud environments, ensuring that permissions adhere to the principle of least privilege.

As a security administrator, you are tasked with reducing the risk of excessive permissions in your organization's cloud environments. Permissions Management allows you to track and manage entitlements efficiently, enhancing security and compliance.

This exercise aims to provide you with practical experience in managing cloud permissions, focusing on minimizing the risk associated with over-privileged identities and ensuring compliance with your organization's security policies.

1. Sign in to the **Azure Portal** and navigate to **Microsoft Defender for Cloud**.

1. In the left menu, open the **Management** menu item, then select **Environment settings**.

1. At the bottom of the page, expand the tentant / subscription tree.

1. Select the Azure subscription you want to manage and ensure the Defender CSPM plan is active.

1. Under the plan settings, enable the **Permissions Management** extension.

1. Select **Continue** and then **Save** to apply the changes.

  >Note - After a few minutes, you'll notice that:
  > - Your subscription has a new Reader assignment for the Cloud Infrastructure Entitlement Management application.
  > - The new Azure CSPM (Preview) standard is assigned to your subscription.

![image](https://github.com/Azure/Microsoft-Defender-for-Cloud/blob/main/Labs/Images/module17Img10.png?raw=true)

1. After enabling, you can access the Permissions Management features through the Defender for Cloud portal.

1. Navigate to the Recommendations page to view new permissions-related recommendations.

![image](https://github.com/Azure/Microsoft-Defender-for-Cloud/blob/main/Labs/Images/module17Img11.png?raw=true)

## You have completed the primary lab - contiue to supplemental labs

1. Use the Permissions Management capabilities to analyze and adjust permissions across your Azure, AWS, or GCP resources.

For further details on enabling and using Permissions Management, refer to the official Microsoft documentation.
